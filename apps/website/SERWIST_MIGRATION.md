# Serwist Migration Guide

## Overview

This document describes the migration from a custom service worker implementation to Serwist, a modern service worker library with excellent TypeScript support and Next.js integration.

## What Changed

### Dependencies Added

- `@serwist/next` (^9.2.1) - Next.js integration plugin
- `@serwist/sw` (^9.2.1) - Service worker utilities
- `@serwist/window` (^9.2.1) - Client-side registration
- `serwist` (^9.2.1) - Core library with strategies and plugins

### Files Modified

#### 1. `app/sw.ts` (New)

- Replaces the old `public/sw.js`
- Written in TypeScript with proper type safety
- Uses Serwist's `installSerwist` function for configuration
- Implements caching strategies:
  - **CacheFirst** for Discord CDN assets (30 days, max 60 entries)
  - **NetworkFirst** for API commands (5 minutes, max 20 entries)
  - **NetworkFirst** for commands page (1 hour, max 5 entries)
  - **NetworkFirst** for navigation (24 hours, max 50 entries)
  - Plus Next.js default caching strategies

#### 2. `next.config.ts`

- Added Serwist webpack plugin integration
- Configured to compile `app/sw.ts` to `public/sw.js`
- Disabled in development mode (Serwist doesn't support Turbopack)

#### 3. `app/components/ui/PWARegister.tsx`

- Updated to use `Serwist` class from `@serwist/window`
- Improved update detection with `installed` event
- Better TypeScript types

#### 4. `package.json`

- Removed `--turbopack` flag from build script (Serwist doesn't support it)
- Development still uses Turbopack for faster dev experience

#### 5. `.gitignore`

- Added generated service worker files:
  - `public/sw.js`
  - `public/sw.js.map`
  - `public/serwist-worker-manifest.json`

#### 6. `tsconfig.json`

- Added `"webworker"` to lib array for service worker types

### Files Removed

- `public/sw.js` - Now auto-generated by Serwist during build

## Benefits

1. **TypeScript Support**: Full type safety for service worker code
2. **Better Caching Strategies**: Built-in strategies (NetworkFirst, CacheFirst, etc.)
3. **Expiration Management**: Automatic cache expiration with ExpirationPlugin
4. **Next.js Integration**: Seamless integration with Next.js build process
5. **Update Management**: Better handling of service worker updates
6. **Maintainability**: Cleaner, more maintainable code structure

## Testing Instructions

### Development Testing

```bash
# Development (Serwist disabled, no service worker)
pnpm dev
```

### Production Testing

```bash
# Build and start
pnpm build
pnpm start

# The service worker will be generated at public/sw.js during build
# Visit http://localhost:3000 and check:
# 1. DevTools > Application > Service Workers
# 2. DevTools > Application > Cache Storage
# 3. Network tab with "Disable cache" unchecked
```

### Verification Steps

1. **Service Worker Registration**

   - Open DevTools > Application > Service Workers
   - Verify service worker is registered with scope "/"
   - Check status is "activated and running"

2. **Caching Behavior**

   - Open DevTools > Application > Cache Storage
   - Verify these caches exist:
     - `discord-cdn-cache`
     - `api-commands-cache`
     - `commands-page-cache`
     - `pages-cache`
     - Next.js default caches (pages-rsc, pages-rsc-prefetch, pages)

3. **Update Notifications**

   - Make a code change and rebuild
   - Deploy the new version
   - Reload the page
   - Verify toast notification appears: "Content Outdated! Please refresh the page to get latest content"

4. **Offline Support**
   - Open DevTools > Network
   - Enable "Offline" mode
   - Navigate to previously visited pages
   - Verify pages load from cache

## Important Notes

### Turbopack Limitation

- Serwist doesn't support Turbopack yet (https://github.com/serwist/serwist/issues/54)
- Development uses Turbopack (fast refresh, no service worker)
- Production builds use standard webpack (with service worker)
- This is intentional and recommended by Serwist team

### Build Process

- Service worker is generated during `next build`
- The generated `public/sw.js` should not be committed to git
- It will be automatically created on each production build

### Deployment

- Ensure `pnpm build` succeeds before deployment
- Verify `public/sw.js` exists after build
- The service worker will be served at `/sw.js`

## Migration Comparison

### Old Implementation (public/sw.js)

```javascript
// Manual cache management
const CACHE_NAME = "skyhelper-v1";
const RUNTIME = "runtime";
// Custom fetch handlers with manual cache logic
async function networkFirst(request) {
  /* ... */
}
async function cacheFirst(request) {
  /* ... */
}
```

### New Implementation (app/sw.ts)

```typescript
// Declarative configuration with TypeScript
installSerwist({
  precacheEntries: self.__SW_MANIFEST,
  runtimeCaching: [
    {
      matcher: /pattern/,
      handler: new NetworkFirst({
        cacheName: "...",
        plugins: [
          new ExpirationPlugin({
            /* ... */
          }),
        ],
      }),
    },
  ],
});
```

## Troubleshooting

### Build Fails with Font Errors

- This is a network restriction in some environments
- Not related to Serwist migration
- Serwist successfully bundles the service worker (check logs for "âœ“ (serwist) Bundling the service worker...")

### Service Worker Not Registering

- Check that `NODE_ENV=production` during build
- Verify `disable` setting in `next.config.ts`
- Check browser console for registration errors

### Update Notifications Not Showing

- Verify `PWARegister` component is rendered in layout
- Check DevTools > Application > Service Workers for update status
- Ensure `info` toast function is working

## Resources

- [Serwist Documentation](https://serwist.pages.dev/)
- [Serwist Next.js Guide](https://serwist.pages.dev/docs/next)
- [Serwist + Turbopack Issue](https://github.com/serwist/serwist/issues/54)
